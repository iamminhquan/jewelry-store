{% extends "base.html" %}
{% block title %}Hóa đơn #{{ invoice.ma_hoa_don }}{% endblock %}
{% block content %}

<div class="bg-gray-50 min-h-screen py-10">
  <div class="container mx-auto max-w-4xl px-4">

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-6 space-y-2">
          {% for category, message in messages %}
          <div class="rounded-lg px-4 py-3 text-sm {% if category == 'success' %}bg-emerald-50 text-emerald-700 border border-emerald-200{% elif category == 'error' %}bg-rose-50 text-rose-700 border border-rose-200{% else %}bg-slate-50 text-slate-700 border border-slate-200{% endif %}">
            {{ message }}
          </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- HEADER -->
    <div class="bg-white p-6 rounded-xl shadow-sm border mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-bold text-gray-800 mb-2">
            Hóa đơn #{{ invoice.ma_hoa_don }}
          </h1>
          <p class="text-sm text-gray-500">
            Hóa đơn điện tử cho đơn hàng của bạn
          </p>
        </div>
        <!-- Status Badge -->
        <span class="inline-flex items-center px-4 py-2 text-sm font-semibold rounded-full 
          {% if invoice.trang_thai == 2 %}bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200
          {% elif invoice.trang_thai == 0 %}bg-amber-100 text-amber-700 ring-1 ring-amber-200
          {% elif invoice.trang_thai == 1 %}bg-blue-100 text-blue-700 ring-1 ring-blue-200
          {% elif invoice.trang_thai == 4 %}bg-red-100 text-red-700 ring-1 ring-red-200
          {% else %}bg-slate-100 text-slate-700 ring-1 ring-slate-200{% endif %}">
          {% if invoice.trang_thai == 2 %}Đã thanh toán
          {% elif invoice.trang_thai == 0 %}Chờ xác nhận
          {% elif invoice.trang_thai == 1 %}Đang xử lý
          {% elif invoice.trang_thai == 4 %}Đã hủy
          {% else %}Không xác định{% endif %}
        </span>
      </div>
    </div>

    <!-- THÔNG TIN HÓA ĐƠN -->
    <div class="bg-white p-6 rounded-xl shadow-sm border mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <p class="text-gray-500">Mã hóa đơn</p>
        <p class="font-semibold">#{{ invoice.ma_hoa_don }}</p>
      </div>
      {% if order %}
      <div>
        <p class="text-gray-500">Mã đơn hàng</p>
        <p class="font-semibold">
          <a href="{{ url_for('user_order.show_order_detail', order_id=order.ma_don_hang) }}" 
             class="text-blue-600 hover:underline">#{{ order.ma_don_hang }}</a>
        </p>
      </div>
      {% endif %}
      <div>
        <p class="text-gray-500">Ngày tạo</p>
        <p class="font-semibold">
          {{ invoice.ngay_tao.strftime('%d/%m/%Y %H:%M') if invoice.ngay_tao else 'N/A' }}
        </p>
      </div>
      <div>
        <p class="text-gray-500">Tổng cộng</p>
        <p class="font-semibold text-rose-600">
          {{ "{:,.0f}₫".format(invoice.tong_tien_tam_tinh) if invoice.tong_tien_tam_tinh else '0₫' }}
        </p>
      </div>
    </div>

    <!-- CHI TIẾT SẢN PHẨM -->
    <div class="bg-white p-6 rounded-xl shadow-sm border mb-8">
      <h3 class="font-bold text-lg mb-4">Chi tiết hóa đơn</h3>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="border-b">
            <tr class="text-left text-gray-500">
              <th class="py-3 pr-4">Sản phẩm</th>
              <th class="py-3 px-4 text-center">Số lượng</th>
              <th class="py-3 px-4 text-right">Đơn giá</th>
              <th class="py-3 pl-4 text-right">Thành tiền</th>
            </tr>
          </thead>
          <tbody>
            {% if invoice_details %}
            {% for item in invoice_details %}
            <tr class="border-b">
              <td class="py-4 pr-4">
                <div class="flex items-center gap-3">
                  {% if item.product and item.product.hinh_anh %}
                  <div class="w-12 h-12 flex-shrink-0 rounded-lg overflow-hidden bg-gray-100 border">
                    <img src="{{ url_for('static', filename=item.product.hinh_anh) }}" 
                         alt="{{ item.product.ten_san_pham if item.product else 'Sản phẩm' }}"
                         class="w-full h-full object-cover">
                  </div>
                  {% else %}
                  <div class="w-12 h-12 flex-shrink-0 rounded-lg bg-gray-200 flex items-center justify-center">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                  {% endif %}
                  <div>
                    <p class="font-medium text-gray-800">
                      {{ item.product.ten_san_pham if item.product else 'Sản phẩm không còn tồn tại' }}
                    </p>
                    <p class="text-xs text-gray-500">Mã SP: {{ item.detail.ma_san_pham }}</p>
                  </div>
                </div>
              </td>
              <td class="py-4 px-4 text-center">{{ item.detail.so_luong }}</td>
              <td class="py-4 px-4 text-right">
                {{ "{:,.0f}₫".format(item.detail.don_gia) if item.detail.don_gia else '0₫' }}
              </td>
              <td class="py-4 pl-4 text-right font-semibold">
                {{ "{:,.0f}₫".format(item.detail.thanh_tien) if item.detail.thanh_tien else '0₫' }}
              </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="4" class="py-8 text-center text-gray-400">
                Không có sản phẩm nào trong hóa đơn này.
              </td>
            </tr>
            {% endif %}
          </tbody>
          <tfoot>
            <tr class="border-t-2 border-gray-200">
              <td colspan="3" class="py-4 text-right font-semibold text-gray-800">Tổng cộng:</td>
              <td class="py-4 pl-4 text-right text-xl font-bold text-rose-600">
                {{ "{:,.0f}₫".format(invoice.tong_tien_tam_tinh) if invoice.tong_tien_tam_tinh else '0₫' }}
              </td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="mt-6 p-4 bg-emerald-50 rounded-lg border border-emerald-200">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-emerald-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <p class="font-medium text-emerald-800">Thanh toán thành công</p>
            <p class="text-sm text-emerald-600 mt-1">
              Cảm ơn bạn đã mua hàng tại cửa hàng. Hóa đơn này là bằng chứng thanh toán của bạn.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- ACTION BUTTONS -->
    <div class="flex flex-col sm:flex-row justify-between gap-4">
      <div class="flex gap-3">
        <a href="{{ url_for('user_order.show_purchase_history') }}"
          class="px-6 py-3 border border-slate-300 rounded-lg text-center hover:bg-gray-100 transition flex items-center gap-2">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Lịch sử mua hàng
        </a>
        {% if order %}
        <a href="{{ url_for('user_order.show_order_detail', order_id=order.ma_don_hang) }}"
          class="px-6 py-3 border border-blue-300 text-blue-700 rounded-lg text-center hover:bg-blue-50 transition flex items-center gap-2">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          Xem đơn hàng
        </a>
        {% endif %}
      </div>

      <a href="{{ url_for('main.show_home_page') }}"
        class="px-6 py-3 bg-rose-600 text-white rounded-lg text-center hover:bg-rose-700 transition font-semibold flex items-center justify-center gap-2">
        Tiếp tục mua hàng
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </a>
    </div>

  </div>
</div>

{% endblock %}
